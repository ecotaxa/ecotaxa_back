# -*- coding: utf-8 -*-
# This file is part of Ecotaxa, see license.md in the application root directory for license informations.
# Copyright (C) 2015-2023  Picheral, Colin, Irisson (UPMC-CNRS)
#
# Generated by a training operation, a prediction associates a class/label predicted
# by an ML algorithm with an object, with a confidence score.
#
from __future__ import annotations

from typing import NamedTuple

from DB.helpers.DDL import Index, Column, ForeignKey, Integer
from DB.helpers.ORM import Model
from DB.helpers.Postgres import BIGINT, INTEGER, DOUBLE_PRECISION
from .Object import ObjectHeader
from .Taxonomy import Taxonomy
from .Training import Training


class ClassifScore(NamedTuple):
    classif: int
    score: float


# TODO: Re-ordering might align and save some bytes per tuple. To experiment with upgrade script.
class Prediction(Model):
    __tablename__ = "prediction"

    training_id = Column(
        Integer,
        ForeignKey(Training.training_id, ondelete="CASCADE"),
        nullable=False,
        primary_key=True,
    )
    object_id = Column(
        BIGINT,
        ForeignKey(ObjectHeader.objid, ondelete="CASCADE"),
        nullable=False,
        primary_key=True,
    )
    classif_id = Column(
        INTEGER,
        ForeignKey(Taxonomy.id, ondelete="CASCADE"),
        nullable=False,
        primary_key=True,
    )
    score = Column(DOUBLE_PRECISION, nullable=False, primary_key=True)


Index(
    "pred_object_id_index",
    Prediction.training_id,
    Prediction.object_id,
    Prediction.classif_id,
    Prediction.score,
    unique=True,
)
